# Исправление проблемы с состоянием DSV при ошибках

## Дата: 2025-12-02

## Проблема

При работе с **Design System Validator (DSV)**:
1. Пользователь запускал проверку без выбранных объектов
2. Отображалась ошибка "Выберите хотя бы один элемент для проверки!"
3. После выбора объектов и повторного запуска проверки - она не срабатывала
4. Кнопка оставалась заблокированной или показывала старые результаты

### Причина

Кнопка проверки и состояние UI не сбрасывались после ошибки:
- Кнопка `dsv-validate-button-main` оставалась заблокированной (`disabled = true`)
- Текст кнопки оставался "Проверка..."
- Предыдущие результаты не очищались
- При повторной попытке проверки кнопка была неактивна

## Решение

### Изменения в `ui.html`

#### 1. Добавлена блокировка кнопки во время проверки (строка ~4535)

```javascript
function runDSVValidation() {
  // ... другой код ...
  
  // Блокируем кнопку проверки на время выполнения
  const validateButtonMain = document.getElementById('dsv-validate-button-main');
  if (validateButtonMain) {
    validateButtonMain.disabled = true;
    validateButtonMain.textContent = 'Проверка...';
  }
  
  // ... остальной код ...
}
```

#### 2. Разблокировка кнопки при ошибке (строка ~5644)

```javascript
} else if (message.type === 'dsv-validation-error') {
  // ... скрытие индикаторов ...
  
  // Очищаем предыдущие результаты
  dsvCurrentReport = null;
  
  // ... показ ошибки ...
  
  // Разблокируем кнопку проверки
  const validateButtonMain = document.getElementById('dsv-validate-button-main');
  if (validateButtonMain) {
    validateButtonMain.disabled = false;
    validateButtonMain.textContent = 'Проверить';
  }
}
```

#### 3. Разблокировка кнопки при успешной проверке (строка ~5901)

```javascript
} else if (message.type === 'dsv-validation-complete') {
  // ... скрытие индикаторов ...
  
  // Разблокируем кнопку проверки
  const validateButtonMain = document.getElementById('dsv-validate-button-main');
  if (validateButtonMain) {
    validateButtonMain.disabled = false;
    validateButtonMain.textContent = 'Проверить';
  }
  
  // ... показ результатов ...
}
```

## Результат

После исправления:
✅ Кнопка блокируется во время проверки (показывает "Проверка...")
✅ При ошибке кнопка разблокируется и возвращается в исходное состояние
✅ Старые результаты очищаются при ошибке
✅ Пользователь может сразу повторить проверку после выбора объектов
✅ Не требуется перезапуск плагина

## Файлы изменены

- `ui.html` - добавлена блокировка/разблокировка кнопки в 3 местах

## Тестирование

### Сценарий 1: Ошибка "Ничего не выбрано"
1. Откройте плагин в режиме DSV
2. Убедитесь, что токены импортированы
3. НЕ выбирайте никакие объекты
4. Нажмите "Проверить"
5. ✅ Должна показаться ошибка "Выберите хотя бы один элемент для проверки!"
6. ✅ Кнопка должна вернуться в состояние "Проверить" и быть активной
7. Выберите фрейм или текстовый элемент
8. Нажмите "Проверить" снова
9. ✅ Проверка должна запуститься и выполниться корректно

### Сценарий 2: Повторная проверка после успешной
1. Выберите объект и запустите проверку
2. Дождитесь результатов
3. ✅ Кнопка должна вернуться в состояние "Проверить"
4. Выберите другой объект
5. Нажмите "Проверить" снова
6. ✅ Проверка должна запуститься заново

## Отличия от ранее исправленного бага

В начале сессии я по ошибке исправил аналогичную проблему в **Icons Checker**, но проблема была в **DSV**. Оба исправления полезны:

- **Icons Checker**: исправлен сброс флага `isCheckingInProgress` в блоках catch
- **DSV**: исправлена блокировка/разблокировка кнопки UI

Оба модуля теперь корректно обрабатывают ошибки и сбрасывают состояние.

## Примечания

Это критическое UX-исправление для DSV. Проблема возникала из-за отсутствия управления состоянием кнопки при ошибках.

