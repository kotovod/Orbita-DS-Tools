# DSV: Настройка пропуска скрытых объектов

**Дата:** 25 декабря 2025  
**Статус:** ✅ Реализовано

## Описание

Добавлена новая настройка в Design System Validator для пропуска скрытых объектов (с `visible = false`) при проверке.

## Зачем это нужно

Скрытые объекты в Figma часто:
- Используются для хранения альтернативных вариантов дизайна
- Служат как временные элементы или черновики
- Не отображаются в финальном UI

Поэтому не имеет смысла проверять их на наличие привязанных токенов дизайн-системы.

## Что изменилось

### 1. UI (`ui.html`)

Добавлен новый чекбокс в блок **"Настройки"** панели Design System Validator:

```html
<div class="settings-item">
  <input type="checkbox" id="dsv-skip-hidden-objects" checked>
  <label for="dsv-skip-hidden-objects">Пропускать скрытые объекты</label>
  <div class="tooltip-icon">?
    <div class="tooltip">Объекты со свойством visible=false будут пропущены при проверке. Скрытые элементы обычно не требуют валидации токенов</div>
  </div>
</div>
```

**Настройка включена по умолчанию** (`checked`).

### 2. JavaScript логика UI

Добавлено чтение настройки и передача её в плагин:

```javascript
const skipHiddenObjectsCheckbox = document.getElementById('dsv-skip-hidden-objects');
const skipHiddenObjects = skipHiddenObjectsCheckbox ? skipHiddenObjectsCheckbox.checked : true;

// В опциях отправки
options: {
  skipInstances: skipInstances,
  filterOrbPrefix: filterOrbPrefix,
  skipZeroValues: skipZeroValues,
  skipHiddenObjects: skipHiddenObjects, // ← новое
  propertiesToCheck: propertiesToCheck
}
```

### 3. Функция валидации (`code.js`)

Добавлена вспомогательная функция для проверки видимости:

```javascript
/**
 * Проверяет, является ли нода или её родители скрытыми
 * @param {SceneNode} node - Нода для проверки
 * @returns {boolean} true если нода или любой её родитель скрыты
 */
function isNodeOrParentHidden(node) {
  let currentNode = node;
  
  while (currentNode) {
    // Проверяем свойство visible у текущей ноды
    if ('visible' in currentNode && currentNode.visible === false) {
      return true;
    }
    
    // Переходим к родителю
    // Останавливаемся на PAGE, т.к. дальше идти не нужно
    if (currentNode.type === 'PAGE' || !currentNode.parent) {
      break;
    }
    
    currentNode = currentNode.parent;
  }
  
  return false;
}
```

В функции `checkNodeVariables` добавлена проверка на скрытые объекты:

```javascript
// 2. Пропускаем скрытые объекты если включена соответствующая настройка
// Проверяем как сам объект, так и всех его родителей
if (options.skipHiddenObjects !== false && isNodeOrParentHidden(node)) {
  console.log(`DSV: Пропущен скрытый объект: ${getSafeNodeName(node)} (${node.type})`);
  return;
}
```

Проверка выполняется **после** исключения `COMPONENT_SET`, но **до** других фильтров (orb-префикс, instances).

## Логика работы

1. **По умолчанию включена** - все скрытые объекты пропускаются
2. **Рекурсивная проверка родителей** - проверяется не только сам объект, но и весь путь до корня (PAGE)
3. **Проверка `visible === false`** - объект считается скрытым если:
   - У самого объекта `visible = false`, ИЛИ
   - У любого родителя по иерархии `visible = false`
4. **Логирование** - в консоль выводится информация о пропущенных скрытых объектах
5. **Можно отключить** - пользователь может снять галочку и проверять все объекты, включая скрытые

### Важно:

В Figma если родительский объект скрыт через иконку глаза в панели слоёв, все его дочерние элементы также становятся невидимыми, даже если у них `visible = true`. Наша проверка учитывает это - если хотя бы один родитель скрыт, весь объект и его дети пропускаются.

## Порядок проверок в `checkNodeVariables`

После внесения изменений порядок фильтрации следующий:

1. ✅ Проверка на существование ноды и ID
2. ✅ Исключение `COMPONENT_SET`
3. ✅ **Пропуск скрытых объектов** (новое)
4. ✅ Фильтрация по префиксу "orb-"
5. ✅ Пропуск instances (если включено)
6. ✅ Проверка свойств на наличие токенов

## Тестирование

### Базовая проверка:

1. Откройте файл с компонентами в Figma
2. Создайте тестовый объект без привязанных токенов
3. Скройте его через иконку глаза в панели слоёв (`visible = false`)
4. Запустите DSV проверку
5. Убедитесь, что скрытый объект **не появился** в списке проблем
6. Снимите галочку "Пропускать скрытые объекты"
7. Запустите проверку снова
8. Убедитесь, что теперь скрытый объект **появился** в списке проблем

### Проверка вложенных объектов:

1. Создайте Frame с несколькими дочерними элементами
2. У дочерних элементов уберите токены (чтобы были ошибки)
3. Скройте **родительский Frame** через иконку глаза
4. Запустите DSV проверку
5. Убедитесь, что **ни один** из дочерних элементов не появился в списке проблем
6. Это работает, даже если у дочерних элементов `visible = true`

### Ожидаемое поведение:

- ✅ Скрытый объект пропускается
- ✅ Дети скрытого объекта пропускаются
- ✅ Если родитель скрыт - все дети автоматически считаются скрытыми
- ✅ Instance внутри скрытого Frame тоже пропускается

## Файлы изменены

- `ui.html` - добавлен чекбокс и логика чтения настройки
- `code.js` - добавлена проверка в функцию `checkNodeVariables`

## Совместимость

- ✅ Обратная совместимость сохранена
- ✅ Если настройка не передана, используется значение по умолчанию `true`
- ✅ Не влияет на другие настройки валидатора
- ✅ Работает со всеми режимами проверки (local, remote, all)

