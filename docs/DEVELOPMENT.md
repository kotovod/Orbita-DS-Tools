# Руководство по разработке плагина Orbita Icon Checker

Этот документ содержит информацию для разработчиков, которые хотят расширить или улучшить функциональность плагина Orbita Icon Checker.

## Структура проекта

Плагин состоит из следующих файлов:

- `manifest.json` - файл манифеста, содержащий информацию о плагине
- `code.js` - основной код плагина, выполняемый в контексте Figma
- `ui.html` - пользовательский интерфейс плагина
- `README.md` - документация по установке и использованию плагина
- `TESTING.md` - инструкции по тестированию плагина
- `EXAMPLES.md` - примеры правильных и неправильных иконок
- `DEVELOPMENT.md` - руководство по разработке (этот файл)

## Основные компоненты

### 1. Манифест (manifest.json)

Файл манифеста содержит основную информацию о плагине:

```json
{
  "name": "Orbita Icon Checker",
  "id": "1234567890123456789",
  "api": "1.0.0",
  "main": "code.js",
  "ui": "ui.html",
  "editorType": ["figma"],
  "menu": [
    {
      "name": "Проверить иконки",
      "command": "check-icons"
    }
  ]
}
```

При публикации плагина необходимо заменить `id` на уникальный идентификатор, полученный от Figma.

### 2. Основной код (code.js)

Основной код плагина содержит логику проверки иконок и взаимодействия с Figma API. Основные функции:

- `figma.showUI(__html__, { width: 400, height: 600 })` - отображение UI плагина
- `figma.ui.onmessage` - обработка сообщений от UI
- `checkIcons(settings)` - основная функция проверки иконок с учетом настроек
- `fixError(nodeId, errorType)` - функция исправления конкретной ошибки
- `fixAllErrors(results)` - функция исправления всех ошибок
- `figma.ui.postMessage({ type: 'progress', message, percent })` - отправка информации о прогрессе в UI
- `figma.ui.postMessage({ type: 'error', message })` - отправка информации об ошибках в UI
- `figma.ui.postMessage({ type: 'fix-result', result })` - отправка результата исправления ошибки
- `figma.ui.postMessage({ type: 'fix-all-result', result })` - отправка результата исправления всех ошибок
- `figma.ui.postMessage({ type: 'settings', settings })` - отправка текущих настроек проверок

### 3. Пользовательский интерфейс (ui.html)

UI плагина содержит HTML, CSS и JavaScript для отображения интерфейса и взаимодействия с пользователем. Основные компоненты:

- Кнопка "Проверить иконки"
- Кнопка "Исправить все ошибки"
- Кнопки "Исправить" для каждой ошибки
- Выпадающий список с чекбоксами для настройки проверок
- Индикатор прогресса с текстовым описанием текущего этапа
- Блок для отображения ошибок
- Функция `displayResults()` для отображения результатов проверки
- Функция `updateProgress()` для обновления индикатора прогресса
- Функция `displayError()` для отображения ошибок
- Функция `displaySuccess()` для отображения сообщений об успехе
- Обработчики событий для взаимодействия с плагином

## Алгоритм проверки иконок

Алгоритм проверки иконок реализован в функции `checkIcons()` и включает следующие шаги:

1. Получение всех Component Set на текущей странице
2. Фильтрация иконок по имени (начинающиеся с "orb-icon-")
3. Проверка каждого варианта в наборе компонентов на соответствие требованиям:
   - Проверка имени компонента
   - Проверка свойств Variant и Size
   - Проверка размеров
   - Проверка структуры (Color-layer и Vector)
   - Проверка выравнивания Color-layer
   - Проверка блокировки Vector
   - Проверка наличия группы Edit
   - Проверка цвета Vector
4. Формирование списка ошибок для каждого компонента
5. Возврат результатов проверки

## Расширение функциональности

### Добавление новых проверок

Для добавления новых проверок необходимо:

1. Добавить новую настройку в объект `defaultCheckSettings` в файле `code.js`
2. Добавить новый чекбокс в UI в файле `ui.html`
3. Добавить новую проверку в функцию `checkIcons()` в файле `code.js`, обернув ее в условие `if (settings.newCheck)`
4. Добавить новый тип ошибки в объект `error` с полями `type` и `message`
5. Добавить обработку нового типа ошибки в функцию `fixError()` в файле `code.js`
6. Обновить документацию (README.md, TESTING.md, EXAMPLES.md)

Пример добавления новой проверки:

```javascript
// Проверка наличия описания компонента
if (!component.description) {
  errors.push('Отсутствует описание компонента');
}
```

### Улучшение пользовательского интерфейса

Для улучшения UI можно:

1. Добавить новые элементы интерфейса в файл `ui.html`
2. Обновить стили в секции `<style>` файла `ui.html`
3. Добавить новые обработчики событий в секции `<script>` файла `ui.html`

### Расширение функций автоматического исправления ошибок

Функции автоматического исправления ошибок уже реализованы в плагине. Для расширения этих функций:

1. Добавьте новый case в функцию `fixError()` в файле `code.js` для обработки нового типа ошибки:

```javascript
case 'newErrorType':
  // Логика исправления новой ошибки
  return { success: true, message: 'Ошибка исправлена' };
```

2. Убедитесь, что новый тип ошибки правильно обрабатывается в функции `fixAllErrors()`.

3. При необходимости обновите UI для отображения результатов исправления.

## Рекомендации по разработке

1. **Тестирование**: Всегда тестируйте плагин на различных иконках, чтобы убедиться, что все проверки работают корректно.

2. **Производительность**: При большом количестве иконок проверка может занимать много времени. Плагин уже имеет индикатор прогресса, но вы можете оптимизировать алгоритм проверки для более быстрой работы.

3. **Обработка ошибок**: Плагин включает базовую обработку ошибок с отображением сообщений в UI. При необходимости вы можете расширить эту функциональность для более детальной диагностики проблем.

4. **Локализация**: Рассмотрите возможность добавления поддержки различных языков.

5. **Документация**: Поддерживайте документацию в актуальном состоянии при внесении изменений в плагин.

## Публикация обновлений

Для публикации обновлений плагина:

1. Внесите необходимые изменения в код
2. Обновите версию в файле `manifest.json`
3. Протестируйте плагин
4. Опубликуйте обновление через Figma Plugin Manager

## Контакты

Если у вас есть вопросы или предложения по улучшению плагина, обращайтесь к команде дизайн-системы Orbita DS.

## Отладка и мониторинг прогресса

Плагин включает функциональность для отслеживания прогресса выполнения и отображения ошибок:

### Отслеживание прогресса

Для отправки информации о прогрессе из кода плагина в UI используйте:

```javascript
figma.ui.postMessage({
  type: 'progress',
  message: 'Описание текущего этапа',
  percent: 50 // процент выполнения (0-100)
});
```

### Обработка ошибок

Для отправки информации об ошибках из кода плагина в UI используйте:

```javascript
figma.ui.postMessage({
  type: 'error',
  message: 'Описание ошибки'
});
```

### Отправка результатов исправления ошибок

Для отправки результата исправления ошибки используйте:

```javascript
figma.ui.postMessage({
  type: 'fix-result',
  result: { success: true, message: 'Ошибка исправлена' }
});
```

### Отправка результатов исправления всех ошибок

Для отправки результата исправления всех ошибок используйте:

```javascript
figma.ui.postMessage({
  type: 'fix-all-result',
  result: {
    success: true,
    message: 'Исправлено X из Y ошибок',
    details: [...] // Детали исправления каждой ошибки
  }
});
```

### Отправка настроек проверок

Для отправки текущих настроек проверок используйте:

```javascript
figma.ui.postMessage({
  type: 'settings',
  settings: { naming: true, variants: true, ... }
});
```

Все основные функции плагина обернуты в блоки try-catch для предотвращения сбоев. При возникновении ошибки пользователь увидит сообщение в UI, а детали ошибки будут записаны в консоль разработчика.