# Диагностика проблемы DSV - результаты не показываются в UI

## Дата: 2025-12-02

## Проблема

Пользователь сообщает:
- Кнопка работает
- Проверка выполняется (видны логи в консоли)
- **НО** вместо отображения найденных ошибок в UI показывается сообщение "Выберите хотя бы один элемент для проверки!"

### Логи из консоли

Пользователь видит:
```
✅ Выбрана переменная из 1.Theme: Colors/orb-text/primary
❌ Цвет в текстом: fills = #34343C (без переменной)
✓ Проверка завершена: 1 элементов, 1 ошибок
```

Это означает, что:
- Проверка **выполняется**
- Результаты **генерируются**
- Но в UI показывается **ошибка** вместо результатов

## Добавлено логирование для диагностики

### В code.js (строка ~2759)

```javascript
} else if (msg.type === 'dsv-validate') {
  try {
    console.log('DSV: Запуск упрощенной проверки (Token Guard версия)');
    console.log('DSV: Выбрано элементов до проверки:', figma.currentPage.selection.length);
    
    const result = await checkNumericVariables();
    
    console.log('DSV: Результат проверки:', result);
    
    figma.ui.postMessage({
      type: 'dsv-validation-complete',
      data: { ... }
    });
  } catch (error) {
    console.error('DSV: Ошибка при проверке:', error);
    ...
  }
}
```

### В ui.html (строка ~5901)

```javascript
} else if (message.type === 'dsv-validation-complete') {
  console.log('DSV UI: Получено сообщение dsv-validation-complete', message.data);
  ...
}
```

### В ui.html (строка ~5644)

```javascript
} else if (message.type === 'dsv-validation-error') {
  console.log('DSV UI: Получено сообщение dsv-validation-error', message.error);
  ...
}
```

## Инструкции для пользователя

1. **Перезапустите плагин** (Cmd+Alt+P)
2. **Выберите текстовый элемент**
3. **Нажмите "Проверить"**
4. **Скопируйте ВСЕ логи из консоли**, включая:
   - `DSV: Запуск упрощенной проверки`
   - `DSV: Выбрано элементов до проверки:`
   - `DSV: Результат проверки:`
   - `DSV UI: Получено сообщение...`

## Возможные причины

1. **Выделение теряется** - между запуском проверки и её выполнением `figma.currentPage.selection` становится пустым
2. **Сообщение не доходит до UI** - по какой-то причине `dsv-validation-complete` не обрабатывается
3. **Два сообщения конфликтуют** - и `dsv-validation-complete`, и `dsv-validation-error` приходят одновременно

Логи помогут определить точную причину.

## Следующие шаги

После получения полных логов мы сможем:
- Определить, какое сообщение приходит в UI
- Понять, теряется ли выделение во время проверки
- Исправить корневую причину проблемы

