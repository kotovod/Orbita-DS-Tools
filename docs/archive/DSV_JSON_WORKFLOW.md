# Design System Validator - Схема работы с JSON токенами

## 📊 Визуальная схема

```
┌─────────────────────────────────────────────────────────────┐
│                    FIGMA DESIGN SYSTEM                       │
│                    (Variables/Tokens)                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │ ЭКСПОРТ
                       ▼
         ┌─────────────────────────────┐
         │  export-tokens-script.js    │
         │  (запустить в консоли)      │
         └─────────────┬───────────────┘
                       │
                       │ JSON
                       ▼
         ┌─────────────────────────────┐
         │   design-tokens.json        │
         │   { "tokens": [...] }       │
         └─────────────┬───────────────┘
                       │
                       │ ЗАГРУЗКА
                       ▼
         ┌─────────────────────────────┐
         │  Orbita Icon Checker UI     │
         │  📁 Загрузить JSON          │
         └─────────────┬───────────────┘
                       │
                       │ СОХРАНЕНИЕ
                       ▼
         ┌─────────────────────────────┐
         │     localStorage            │
         │  (dsv-tokens-json)          │
         └─────────────┬───────────────┘
                       │
                       │ ИСПОЛЬЗОВАНИЕ
                       ▼
         ┌─────────────────────────────┐
         │  Design System Validator    │
         │  (code.js)                  │
         └─────────────┬───────────────┘
                       │
                       │ ПРОВЕРКА
                       ▼
         ┌─────────────────────────────┐
         │   Элементы в Figma          │
         │   (Components, Frames...)   │
         └─────────────┬───────────────┘
                       │
                       │ РЕЗУЛЬТАТ
                       ▼
         ┌─────────────────────────────┐
         │   Отчёт о проверке          │
         │   (проблемы и статистика)   │
         └─────────────────────────────┘
```

---

## 🔄 Алгоритм проверки токенов

```
Начало проверки
│
├─ Есть JSON токены?
│  │
│  ├─ НЕТ → Использовать Figma API (getLocalVariablesAsync)
│  │        ├─ Получить все variables
│  │        ├─ Фильтровать по режиму (local/remote/all)
│  │        └─ Создать Map токенов
│  │
│  └─ ДА → Использовать JSON токены
│           ├─ Парсить JSON
│           ├─ Валидировать структуру
│           ├─ Создать совместимые объекты
│           ├─ Фильтровать по режиму
│           └─ Создать Map токенов
│
├─ Получить элементы для проверки
│  ├─ Выделены объекты? → Проверить выделенные
│  └─ Ничего не выделено? → Проверить всю страницу
│
├─ Для каждого элемента:
│  │
│  ├─ Получить boundVariables
│  │
│  ├─ Для каждого свойства (fill, stroke, spacing...):
│  │  │
│  │  ├─ Есть boundVariable?
│  │  │  │
│  │  │  ├─ ДА → Проверить токен
│  │  │  │      │
│  │  │  │      ├─ Найден по ID в Map? → ✅ OK
│  │  │  │      │
│  │  │  │      └─ НЕ найден по ID?
│  │  │  │         ├─ Получить реальный токен из Figma API
│  │  │  │         ├─ Найти по имени в Map токенов
│  │  │  │         ├─ Найден по имени? → ✅ OK (JSON токены)
│  │  │  │         └─ Не найден? → ❌ Проблема!
│  │  │  │
│  │  │  └─ НЕТ → Проверить значение свойства
│  │  │         ├─ Есть значение? → ⚠️ Нет токена
│  │  │         └─ Нет значения? → Пропустить
│  │  │
│  │  └─ Записать результат
│  │
│  └─ Обновить прогресс
│
└─ Сформировать отчёт
   ├─ Общая статистика
   ├─ Список проблем
   └─ Отправить в UI
```

---

## 🎯 Логика сравнения токенов

### Вариант 1: Figma API токены

```
Element boundVariable ID: "VariableID:123:456"
                │
                ▼
    Map токенов (из Figma API)
    ├─ "VariableID:123:456" → ✅ Найден
    └─ Токен валиден
```

### Вариант 2: JSON токены (совпадение по ID)

```
Element boundVariable ID: "VariableID:123:456"
                │
                ▼
    Map токенов (из JSON)
    ├─ "VariableID:123:456" → ✅ Найден
    └─ Токен валиден
```

### Вариант 3: JSON токены (поиск по имени)

```
Element boundVariable ID: "VariableID:123:456"
                │
                ▼
    Map токенов (из JSON)
    ├─ "VariableID:123:456" → ❌ НЕ найден
    │
    ▼ Получить реальный токен из Figma API
    │
    ├─ variable.name = "color/primary/500"
    │
    ▼ Искать по имени в Map токенов
    │
    ├─ findTokenByName("color/primary/500")
    │
    └─ "color/primary/500" → ✅ Найден
       └─ Токен валиден (JSON)
```

---

## 🔀 Режимы работы

### Режим 1: Без JSON (стандартный)

```
UI (пользователь) 
    → Нажимает "Проверить Variables"
        → НЕТ JSON в localStorage
            → code.js: getVariablesByMode(mode, null)
                → figma.variables.getLocalVariablesAsync()
                    → Проверка элементов
                        → Отчёт
```

### Режим 2: С JSON

```
UI (пользователь)
    → Загружает JSON файл
        → Валидация
            → Сохранение в localStorage
                → Нажимает "Проверить Variables"
                    → ЕСТЬ JSON в localStorage
                        → code.js: getVariablesByMode(mode, tokensFromJson)
                            → Использование JSON токенов
                                → Проверка элементов
                                    → Отчёт
```

---

## 📦 Структура данных

### JSON токен (входные данные)

```json
{
  "name": "color/primary/500",
  "type": "COLOR",
  "value": "#F86025",
  "isRemote": true,
  "description": "Основной цвет"
}
```

### Токен в Map (внутренний формат)

```javascript
{
  id: "json-token-color-primary-500",  // Сгенерирован
  name: "color/primary/500",            // Из JSON
  type: "COLOR",                        // Из JSON
  remote: true,                         // isRemote из JSON
  value: "#F86025",                     // Из JSON
  description: "Основной цвет",         // Из JSON
  scopes: [],                           // Из JSON
  resolvedType: "COLOR"                 // type из JSON
}
```

### Figma variable (API)

```javascript
{
  id: "VariableID:123:456",            // Реальный ID
  name: "color/primary/500",           // Имя
  resolvedType: "COLOR",               // Тип
  remote: true,                        // Local/Remote
  // ... другие поля
}
```

---

## 🔍 Проверка работы (логи)

### С JSON токенами

```
DSV: Начало проверки, режим: remote
DSV: Найдено нод для проверки: 45
DSV: Используются токены из JSON файла: 127
DSV: Загружено variables: 127 шт.
DSV: Используются токены из загруженного JSON файла: 127
DSV: === ТОКЕНЫ ИЗ JSON (первые 10) ===
  1. color/primary/500 (type: COLOR, remote: true)
  2. spacing/md (type: FLOAT, remote: true)
  ...
```

### Без JSON (Figma API)

```
DSV: Начало проверки, режим: remote
DSV: Найдено нод для проверки: 45
DSV: Используются токены из Figma API
DSV: Получено всего variables: 32
DSV: Загружено variables: 32 шт.
DSV: === ПОЛНЫЙ СПИСОК VARIABLES ===
DSV: Local variables:
  1. local-color (ID: VariableID:1:2...)
  ...
DSV: Remote variables:
  1. remote-color (ID: VariableID:3:4...)
  ...
```

---

## 📊 Сравнение подходов

| Параметр | Figma API | JSON Tokens |
|----------|-----------|-------------|
| Источник | `getLocalVariablesAsync()` | JSON файл |
| Количество | 32 (ограничено API) | 100+ (полный список) |
| Remote токены | Не все видны | Все токены |
| Зависимость | Figma API | Независим |
| Настройка | Нет | Нужно загрузить JSON |
| Обновление | Автоматически | Вручную |
| Проверка | По ID | По ID + имени |

---

## 🎯 Рекомендации

### Когда использовать Figma API (без JSON)
✅ Все токены локальные (в текущем файле)  
✅ Remote токены видны корректно  
✅ Быстрая проверка без подготовки  

### Когда использовать JSON
✅ Remote токены не видны через API  
✅ Нужна проверка по полному списку токенов  
✅ Токены из внешних систем (Tokens Studio и др.)  
✅ Нужна версионность токенов  

---

## 🚀 Workflow для команды

### Один раз (настройка)
1. Экспортировать токены из главной библиотеки
2. Сохранить JSON в репозиторий команды
3. Документировать процесс

### Регулярно (использование)
1. Скачать актуальный JSON из репозитория
2. Загрузить в плагин
3. Запустить проверку компонентов
4. Исправить найденные проблемы

### При обновлении токенов
1. Обновить JSON из библиотеки
2. Закоммитить в репозиторий
3. Уведомить команду

---

**Версия**: 3.0.3  
**Дата**: Октябрь 16, 2025

