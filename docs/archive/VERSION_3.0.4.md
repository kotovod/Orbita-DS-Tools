# Version 3.0.4 — Token Suggestions Fix

**Дата:** 16 октября 2025

## Что исправлено

Основная проблема: **Плагин не предлагал токены на замену для fills/strokes**.

### Исправления:

1. **Поиск токенов для fills/strokes**
   - Функция `findTokenByValue()` теперь правильно обрабатывает массивы paint объектов
   - Извлекает цвет из первого SOLID fill/stroke
   - Рекурсивно вызывает себя для поиска по RGB значению

2. **Поддержка токенов-алиасов**
   - Использует `resolvedValue` при поиске совпадений
   - Правильно разрешает цепочки алиасов через внешние библиотеки

3. **HEX значения**
   - Добавлена функция `rgbToHex()` для конвертации
   - HEX значения добавлены в экспорт JSON
   - Удобная отладка в консоли

4. **Передача оригинальных значений**
   - Исправлена передача raw значений (`node[prop.key]`) вместо JSON строк (`getPropertyValue()`)
   - `getPropertyValue()` используется только для отображения

5. **Токены из внешних библиотек**
   - `bindTokenToProperty()` ищет токены по имени в используемых переменных документа
   - Поддержка remote токенов из подключённых библиотек

6. **Правильная привязка fills/strokes**
   - Использует `figma.variables.setBoundVariableForPaint(paint, 'color', variable)`
   - Вместо неправильного `node.setBoundVariable(property, variable)`

7. **Обработка ошибок IndexedDB**
   - Токены работают в памяти даже если не сохраняются навсегда
   - Показывает предупреждение в UI

## Как работает

### Пример: элемент с цветом #34343C без токена

1. **Валидация** находит что fills не привязан к токену
2. **Поиск токена:**
   ```
   fills = [{type: "SOLID", color: {r: 0.204, g: 0.204, b: 0.235}}]
   → извлекает color
   → ищет токен с RGB(0.204, 0.204, 0.235)
   → находит "orb-text/static/heavy"
   ```
3. **Показывает в UI:** кнопка "Исправить" с токеном `orb-text/static/heavy`
4. **При клике на "Исправить":**
   - Ищет токен по ID или имени (включая remote)
   - Привязывает через `setBoundVariableForPaint()`
   - ✅ Токен привязан!

## Тестирование

### Сценарий 1: Hardcoded fills
1. Создать прямоугольник с цветом из design system
2. НЕ привязывать токен
3. Запустить DSV проверку
4. **Результат:** Показывает проблему + кнопка "Исправить" с правильным токеном

### Сценарий 2: Токены из библиотек
1. Элемент использует хардкод цвет из библиотеки
2. Экспортировать токены (включая remote)
3. Загрузить JSON в плагин
4. Запустить проверку
5. **Результат:** Находит токен по имени и предлагает привязать

## Технические детали

### Ключевые функции:

**`findTokenByValue(variables, value, propertyType)`**
- Проверяет `Array.isArray(value)`
- Извлекает `value[0].color` для fills/strokes
- Рекурсивно вызывает себя с RGB объектом
- Использует `token.resolvedValue` для алиасов
- Точность сравнения RGB: 0.01

**`bindTokenToProperty(nodeId, property, tokenId)`**
- Ищет токен в JSON → получает имя
- Пробует найти по ID через API
- Если не найден → ищет по имени в используемых токенах
- Для fills/strokes: `setBoundVariableForPaint(paint, 'color', variable)`

**`rgbToHex(rgb)`**
- Конвертирует {r, g, b, a} в #RRGGBB[AA]
- Используется для отладки и логирования

## Файлы изменены

- `code.js` - основные исправления
- `ui.html` - обработка ошибок сохранения
- `manifest.json` - очищен от лишних полей
- `CHANGELOG_v3.0.0.md` - документация изменений

## Версия плагина

v3.0.4 (внутренняя версия в коде, в manifest не указывается)

