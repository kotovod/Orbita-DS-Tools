<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    :root {
      /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
      --bg-page: #FFFFFF;
      --text-primary: #34343C;
      --text-secondary: #666666;
      --button-bg: rgba(181, 183, 192, 0.25);
      --button-hover: rgba(181, 183, 192, 0.35);
      --icon-color: #34343C;
      --back-button-icon: #6B6C77;
      --back-button-hover: rgba(181, 183, 192, 0.2);
      --divider-color: #e5e5e5;
      --section-bg: #f5f5f5;
      --border-color: #e5e5e5;
      --hover-bg: #f8f9fa;
      --success-bg: #d4f4dd;
      --success-color: #0d5e2a;
      --error-bg: #fee2e2;
      --error-color: #991b1b;
      --info-bg: #dbeafe;
      --info-color: #1e40af;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        --bg-page: #2C2C2C;
        --text-primary: #F3F4F5;
        --text-secondary: #B5B7C0;
        --button-bg: rgba(181, 183, 192, 0.25);
        --button-hover: rgba(181, 183, 192, 0.35);
        --icon-color: #F3F4F5;
        --back-button-icon: #BDBFC8;
        --back-button-hover: rgba(181, 183, 192, 0.2);
        --divider-color: rgba(181, 183, 192, 0.2);
        --section-bg: rgba(181, 183, 192, 0.1);
        --border-color: rgba(181, 183, 192, 0.2);
        --hover-bg: rgba(181, 183, 192, 0.15);
        --success-bg: rgba(16, 185, 129, 0.2);
        --success-color: #6ee7b7;
        --error-bg: rgba(239, 68, 68, 0.2);
        --error-color: #fca5a5;
        --info-bg: rgba(59, 130, 246, 0.2);
        --info-color: #93c5fd;
      }
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 0;
      background: var(--bg-page);
      color: var(--text-primary);
    }

    .container {
      display: flex;
      flex-direction: column;
    }

    .content-padding {
      padding: 0 20px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }
    
    #importPage.active {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #checkPage.active {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #colorsPage.active {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #checkResultSection {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      padding: 16px 0 20px 0;
      min-height: 0;
    }
    
    #checkResultSection.visible {
      display: flex;
    }
    
    #checkResultSection h2 {
      flex-shrink: 0;
      margin-bottom: 12px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    #errorsTable {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      display: none;
      flex-direction: column;
    }
    
    #errorsTable.visible {
      display: block;
    }
    
    #resultSection {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    
    #resultSection.visible {
      display: flex;
    }
    
    body, html {
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      height: 100vh;
      overflow: hidden;
    }

    .menu-item {
      padding: 12px 20px;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: none;
    }

    .menu-item:hover {
      background: var(--hover-bg);
    }

    .menu-item-title {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-primary);
    }

    .menu-section-title {
      padding: 8px 20px;
      margin-top: 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .error-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: rgba(239, 68, 68, 0.2);
      color: #F58F8F;
      font-size: 11px;
      font-weight: 600;
      border-radius: 10px;
      margin-left: 8px;
    }
    
    .button-link {
      background: none;
      border: none;
      color: #629BF8;
      font-size: 12px;
      font-weight: 400;
      padding: 0;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.2s;
      flex: none;
      white-space: nowrap;
    }
    
    .button-link:hover {
      opacity: 0.7;
    }

    .menu-item-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .menu-item-arrow svg {
      width: 16px;
      height: 16px;
    }
    
    .menu-item-arrow svg path {
      stroke: var(--icon-color);
    }

    .divider {
      height: 1px;
      background: var(--divider-color);
      margin: 0;
      width: 100%;
    }

    .page-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 20px 8px 8px;
    }

    .back-button {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
      flex: none;
      flex-shrink: 0;
    }

    .back-button:hover {
      background: #373737;
    }

    .back-button svg {
      width: 16px;
      height: 16px;
    }
    
    .back-button svg path {
      stroke: var(--back-button-icon);
    }

    .page-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    h1 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .section {
      padding: 16px 20px;
      background: var(--section-bg);
      border-radius: 0;
      border: none;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
    }

    .description {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .main-description {
      padding: 12px 20px 12px 20px;
    }
    
    .page-header {
      padding-top: 12px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      resize: vertical;
      background: var(--bg-page);
      color: var(--text-primary);
    }

    #resultJson {
      flex: 1;
      height: 100%;
      resize: none;
    }

    textarea:focus {
      outline: none;
      border-color: var(--icon-color);
      box-shadow: 0 0 0 2px var(--button-bg);
    }

    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    button {
      flex: 1;
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .button-primary {
      background: var(--button-bg);
      color: var(--text-primary);
    }

    .button-primary:hover {
      background: var(--button-hover);
    }

    .button-primary:active {
      opacity: 0.8;
    }

    .button-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .button-secondary:hover {
      background: var(--hover-bg);
    }

    .message {
      padding: 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 12px;
      display: none;
    }

    .message.success {
      background: var(--success-bg);
      color: var(--success-color);
      border: 1px solid var(--success-color);
      display: block;
    }

    .message.error {
      background: var(--error-bg);
      color: var(--error-color);
      border: 1px solid var(--error-color);
      display: block;
    }

    .status {
      padding: 16px 20px;
      background: #383838;
      border-radius: 0;
      font-size: 12px;
      color: var(--text-primary);
      border: none;
    }

    .status-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .status-row {
      margin-bottom: 4px;
      color: var(--text-secondary);
    }
    
    .status-row:last-child {
      margin-bottom: 0;
    }

    .status-label {
      color: var(--text-secondary);
    }

    .status-value {
      color: var(--text-primary);
      font-weight: 500;
    }

    .example {
      margin-top: 12px;
      padding: 12px;
      background: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    .example-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .example-code {
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: block;
      padding: 12px;
      background: var(--bg-page);
      border: 2px dashed var(--border-color);
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .file-label:hover {
      background: var(--hover-bg);
      border-color: var(--icon-color);
      color: var(--text-primary);
    }

    .separator {
      text-align: center;
      font-size: 12px;
      color: #999999;
      margin: 12px 0;
      position: relative;
    }

    .separator::before,
    .separator::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 35%;
      height: 1px;
      background: var(--divider-color);
    }

    .separator::before {
      left: 0;
    }

    .separator::after {
      right: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="mainPage" class="page active">
      <p class="description main-description">
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∞–∫–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—ã –∏ –ø–æ–º–æ–≥–∞–µ—Ç –≤—Å—ë –±—ã—Å—Ç—Ä–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
      </p>

      <div class="divider"></div>

      <div class="menu-item" id="menuImport">
        <span class="menu-item-title">–ò–º–ø–æ—Ä—Ç –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—ã</span>
        <span class="menu-item-arrow">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </span>
      </div>

      <div class="divider"></div>

      <div class="menu-section-title">–ü—Ä–æ–≤–µ—Ä–∫–∞</div>

      <div class="menu-item" id="menuCheck">
        <span class="menu-item-title">–ß–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</span>
        <span class="menu-item-arrow">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </span>
      </div>

      <div class="divider"></div>

      <div class="menu-item" id="menuColors">
        <span class="menu-item-title">–¶–≤–µ—Ç–∞</span>
        <span class="menu-item-arrow">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </span>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–º–ø–æ—Ä—Ç–∞ -->
    <div id="importPage" class="page">
      <div class="page-header">
        <button class="back-button" id="backToMain">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </button>
        <h2 class="page-title">–ò–º–ø–æ—Ä—Ç –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—ã</h2>
      </div>

      <div class="divider"></div>

      <p class="description main-description">
        –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Figma —Ñ–∞–π–ª–∞, –≥–¥–µ –±–æ–ª–µ–µ 5 —á–∏—Å–ª–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö. –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞.
      </p>

      <div class="divider"></div>

      <div id="importContainer" style="padding: 16px 20px;">
        <button class="button-primary" id="importFromFileBtn" style="width: 100%;">
          üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
        </button>

        <div id="message" class="message"></div>
      </div>

      <div id="statusSection" class="status" style="display: none;">
        <div class="status-title">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
        <div id="statusText"></div>
      </div>

      <div id="resultSection" class="section" style="background: transparent; border: none; padding: 16px 20px 20px 20px;">
        <h2>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</h2>
        <textarea 
          id="resultJson" 
          readonly
          placeholder='–†–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...'></textarea>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
    <div id="checkPage" class="page">
      <div class="page-header">
        <button class="back-button" id="backToMainFromCheck">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </button>
        <h2 class="page-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å–ª–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</h2>
      </div>

      <div class="divider"></div>

      <p class="description main-description">
        <strong>–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç</strong><br>
        Gap –≤ Autolayot<br>
        Corner radius<br>
        Padding
      </p>

      <div class="divider"></div>

      <div style="padding: 16px 20px;">
        <button class="button-primary" id="checkBtn" style="width: 100%;">
          üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ—Ä–µ–π–º
        </button>
      </div>

      <div id="checkResultSection">
        <h2>
          <div>
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
            <span id="errorBadge" class="error-badge" style="display: none;">0</span>
          </div>
          <button class="button-link" id="fixAllBtn" style="display: none;">
            –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ
          </button>
        </h2>
        
        <div id="errorsTable">
          <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: var(--text-primary);">
            <thead>
              <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 8px 8px 8px 20px; text-align: left; font-weight: 600; color: var(--text-primary);">–≠–ª–µ–º–µ–Ω—Ç</th>
                <th style="padding: 8px; text-align: left; font-weight: 600; color: var(--text-primary);">–û—à–∏–±–æ–∫</th>
                <th style="padding: 8px 20px 8px 8px; text-align: center; font-weight: 600; color: var(--text-primary);">–î–µ–π—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
            <tbody id="errorsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–≤–µ—Ç–æ–≤ -->
    <div id="colorsPage" class="page">
      <div class="page-header">
        <button class="back-button" id="backToMainFromColors">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
        </button>
        <h2 class="page-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–≤–µ—Ç–æ–≤</h2>
      </div>

      <div class="divider"></div>

      <p class="description main-description">
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ, –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö –∏ —Ä–µ–∂–∏–º–∞—Ö.
      </p>

      <div class="divider"></div>

      <div style="padding: 16px 20px;">
        <button class="button-primary" id="analyzeColorsBtn" style="width: 100%;">
          üé® –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–≤–µ—Ç–∞
        </button>
      </div>

      <div id="colorsResultSection" style="flex: 1; display: none; flex-direction: column; overflow: hidden; padding: 16px 0 20px 0; min-height: 0;">
        <h2 style="flex-shrink: 0; margin-bottom: 12px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
          <div>
          –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
            <span id="colorErrorBadge" class="error-badge" style="display: none;">0</span>
          </div>
          <button class="button-link" id="fixAllColorsBtn" style="display: none;">
            –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ
          </button>
        </h2>
        
        <div id="colorsContent" style="flex: 1; overflow-y: auto; min-height: 0; padding: 0 20px;">
          <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–≤–µ—Ç–∞—Ö -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const mainPage = document.getElementById('mainPage');
    const importPage = document.getElementById('importPage');
    const checkPage = document.getElementById('checkPage');
    const colorsPage = document.getElementById('colorsPage');
    const menuImport = document.getElementById('menuImport');
    const menuCheck = document.getElementById('menuCheck');
    const menuColors = document.getElementById('menuColors');
    const backToMain = document.getElementById('backToMain');
    const backToMainFromCheck = document.getElementById('backToMainFromCheck');
    const backToMainFromColors = document.getElementById('backToMainFromColors');
    const importContainer = document.getElementById('importContainer');
    const importFromFileBtn = document.getElementById('importFromFileBtn');
    const checkBtn = document.getElementById('checkBtn');
    const messageEl = document.getElementById('message');
    const statusSection = document.getElementById('statusSection');
    const statusText = document.getElementById('statusText');
    const resultSection = document.getElementById('resultSection');
    const resultJson = document.getElementById('resultJson');
    const checkResultSection = document.getElementById('checkResultSection');
    const errorBadge = document.getElementById('errorBadge');
    const errorsTable = document.getElementById('errorsTable');
    const errorsTableBody = document.getElementById('errorsTableBody');
    const fixAllBtn = document.getElementById('fixAllBtn');
    const analyzeColorsBtn = document.getElementById('analyzeColorsBtn');
    const colorsResultSection = document.getElementById('colorsResultSection');
    const colorsContent = document.getElementById('colorsContent');
    const fixAllColorsBtn = document.getElementById('fixAllColorsBtn');
    const colorErrorBadge = document.getElementById('colorErrorBadge');
    
    let currentErrors = []; // –•—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–µ –æ—à–∏–±–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    let currentColorErrors = []; // –•—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    let isLibraryFile = false; // –•—Ä–∞–Ω–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ —Ñ–∞–π–ª–∞

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageName).classList.add('active');
    }

    menuImport.addEventListener('click', () => {
      showPage('importPage');
    });

    menuCheck.addEventListener('click', () => {
      showPage('checkPage');
    });

    menuColors.addEventListener('click', () => {
      showPage('colorsPage');
    });

    backToMain.addEventListener('click', () => {
      showPage('mainPage');
    });

    backToMainFromCheck.addEventListener('click', () => {
      showPage('mainPage');
    });

    backToMainFromColors.addEventListener('click', () => {
      showPage('mainPage');
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    function showMessage(text, type, element = messageEl) {
      element.textContent = text;
      element.className = `message ${type}`;
      
      setTimeout(() => {
        element.className = 'message';
      }, 5000);
    }

    // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑–∞—Ç—å JSON
    function updateStatus(data) {
      if (data && data.variables) {
        statusSection.style.display = 'block';
        resultSection.classList.add('visible');
        
        const tokenCount = data.count || Object.keys(data.variables).length;
        const date = data.timestamp ? new Date(data.timestamp).toLocaleString('ru-RU', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : '';
        
        statusText.innerHTML = `
          <div class="status-row"><span class="status-label">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:</span> <span class="status-value">${tokenCount}</span></div>
          ${date ? `<div class="status-row"><span class="status-label">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:</span> <span class="status-value">${date}</span></div>` : ''}
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º JSON –≤ readonly –ø–æ–ª–µ
        resultJson.value = JSON.stringify(data.variables, null, 2);
      } else {
        statusSection.style.display = 'none';
        resultSection.classList.remove('visible');
      }
    }

    // –ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
    importFromFileBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: {
          type: 'import-from-file'
        }
      }, '*');
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∏—Å–ª–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    checkBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: {
          type: 'check-numeric-variables'
        }
      }, '*');
    });

    // –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –æ—à–∏–±–∫–∏
    fixAllBtn.addEventListener('click', () => {
      if (currentErrors.length > 0) {
        parent.postMessage({
          pluginMessage: {
            type: 'fix-all-errors',
            errors: currentErrors
          }
        }, '*');
      }
    });

    // –ê–Ω–∞–ª–∏–∑ —Ü–≤–µ—Ç–æ–≤
    analyzeColorsBtn.addEventListener('click', () => {
      parent.postMessage({
        pluginMessage: {
          type: 'collect-modes'
        }
      }, '*');
    });

    // –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –æ—à–∏–±–∫–∏
    fixAllColorsBtn.addEventListener('click', () => {
      if (currentColorErrors.length > 0) {
      parent.postMessage({
        pluginMessage: {
            type: 'fix-all-color-errors',
            errors: currentColorErrors
        }
      }, '*');
      }
    });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    parent.postMessage({
      pluginMessage: {
        type: 'check-memory-status'
      }
    }, '*');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
    function updateImportButton(isLibrary) {
      isLibraryFile = isLibrary;
      
      if (!isLibrary) {
        // –≠—Ç–æ –æ–±—ã—á–Ω—ã–π —Ñ–∞–π–ª - —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –∏–º–ø–æ—Ä—Ç–∞
        importContainer.style.display = 'none';
      } else {
        // –≠—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–æ–π –∏–º–ø–æ—Ä—Ç–∞
        importContainer.style.display = 'block';
      }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'saved-to-memory') {
        showMessage(`–£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ! (${msg.data.count} –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)`, 'success');
        updateStatus(msg.data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        if (msg.isLibrary !== undefined) {
          updateImportButton(msg.isLibrary);
        }
      }
      
      if (msg.type === 'loaded-from-memory') {
        updateStatus(msg.data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        if (msg.isLibrary !== undefined) {
          updateImportButton(msg.isLibrary);
        }
      }
      
      if (msg.type === 'memory-empty') {
        statusSection.style.display = 'none';
        resultSection.classList.remove('visible');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
        if (msg.isLibrary !== undefined) {
          updateImportButton(msg.isLibrary);
        }
      }
      
      if (msg.type === 'error') {
        showMessage(msg.message, 'error');
      }

      if (msg.type === 'check-result') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
        checkResultSection.classList.add('visible');
        
        const { checked, errors, stats } = msg.data;
        currentErrors = errors; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—à–∏–±–æ–∫
        if (errors.length > 0) {
          errorBadge.textContent = errors.length;
          errorBadge.style.display = 'inline-flex';
        } else {
          errorBadge.style.display = 'none';
        }
        
        if (errors.length > 0) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—à–∏–±–∫–∞–º–∏
          errorsTable.classList.add('visible');
          fixAllBtn.style.display = 'block';
          errorsTableBody.innerHTML = '';
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
          const groupedErrors = {};
          errors.forEach(error => {
            const key = `${error.nodeId}_${error.nodeName}`;
            if (!groupedErrors[key]) {
              groupedErrors[key] = {
                nodeName: error.nodeName,
                nodeId: error.nodeId,
                errors: []
              };
            }
            groupedErrors[key].errors.push(error);
          });
          
          // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
          Object.values(groupedErrors).forEach(group => {
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid var(--border-color)';
            row.style.transition = 'background 0.2s';
            row.style.background = 'transparent';
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤ –≥—Ä—É–ø–ø–µ
            const errorCount = group.errors.length;
            
            row.innerHTML = `
              <td style="padding: 8px 8px 8px 20px; cursor: pointer; color: var(--text-primary);" class="node-name-cell">${group.nodeName}</td>
              <td style="padding: 8px; cursor: pointer; color: var(--text-primary);" class="node-name-cell">${errorCount}</td>
              <td style="padding: 8px 20px 8px 8px; text-align: center;">
                <button class="button-primary fix-btn" style="padding: 4px 12px; font-size: 12px; cursor: pointer;">
                  –ò—Å–ø—Ä–∞–≤–∏—Ç—å
                </button>
              </td>
            `;
            
            // –ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–∞–º (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏) - —Ñ–æ–∫—É—Å
            const nameCells = row.querySelectorAll('.node-name-cell');
            nameCells.forEach(cell => {
              cell.onmouseover = () => row.style.background = 'var(--hover-bg)';
              cell.onmouseout = () => row.style.background = 'transparent';
              cell.onclick = () => {
                parent.postMessage({
                  pluginMessage: {
                    type: 'focus-node',
                    nodeId: group.nodeId
                  }
                }, '*');
              };
            });
            
            // –ö–Ω–æ–ø–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å - –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ –≤ –≥—Ä—É–ø–ø–µ
            const fixBtn = row.querySelector('.fix-btn');
            fixBtn.onclick = (e) => {
              e.stopPropagation();
              // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –≤ –≥—Ä—É–ø–ø–µ
              group.errors.forEach(error => {
                parent.postMessage({
                  pluginMessage: {
                    type: 'fix-error',
                    error: error
                  }
                }, '*');
              });
            };
            
            errorsTableBody.appendChild(row);
          });
          
          // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö —É–¥–∞–ª–µ–Ω–æ
        } else {
          errorsTable.classList.remove('visible');
          fixAllBtn.style.display = 'none';
          // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ —É–¥–∞–ª–µ–Ω–æ
        }
      }

      if (msg.type === 'error-fixed') {
        // –û—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–æ
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
        setTimeout(() => {
          checkBtn.click();
        }, 500);
      }

      if (msg.type === 'fix-all-complete') {
        // –í—Å–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
        // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —É–¥–∞–ª–µ–Ω–æ
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(() => {
          checkBtn.click();
        }, 500);
      }

      if (msg.type === 'modes-result') {
        colorsResultSection.style.display = 'flex';
        
        const { data } = msg;
        let html = '';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤—ã–µ –æ—à–∏–±–∫–∏
        currentColorErrors = data.colorErrors || [];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—à–∏–±–æ–∫
        if (currentColorErrors.length > 0) {
          colorErrorBadge.textContent = currentColorErrors.length;
          colorErrorBadge.style.display = 'inline-flex';
          fixAllColorsBtn.style.display = 'block';
        } else {
          colorErrorBadge.style.display = 'none';
          fixAllColorsBtn.style.display = 'none';
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—à–∏–±–∫–∞–º–∏
        if (data.colorErrors && data.colorErrors.length > 0) {
          html += '<div style="margin-top: 16px;">';
          html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">';
          html += '<h3 style="font-size: 12px; font-weight: 600; color: var(--text-primary);">';
          html += '–¶–≤–µ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö';
          html += '</h3>';
          html += '</div>';
          
          html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px; color: var(--text-primary);">';
          html += '<thead>';
          html += '<tr style="border-bottom: 2px solid var(--border-color);">';
          html += '<th style="padding: 8px 8px 8px 0; text-align: left; font-weight: 600; color: var(--text-primary);">–≠–ª–µ–º–µ–Ω—Ç</th>';
          html += '<th style="padding: 8px; text-align: left; font-weight: 600; color: var(--text-primary);">–û—à–∏–±–æ–∫</th>';
          html += '<th style="padding: 8px 0 8px 8px; text-align: center; font-weight: 600; color: var(--text-primary);">–î–µ–π—Å—Ç–≤–∏–µ</th>';
          html += '</tr>';
          html += '</thead>';
          html += '<tbody>';
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
          const groupedErrors = {};
          data.colorErrors.forEach(error => {
            const key = error.nodeId + '_' + error.nodeName;
            if (!groupedErrors[key]) {
              groupedErrors[key] = {
                nodeName: error.nodeName,
                nodeId: error.nodeId,
                errors: []
              };
            }
            groupedErrors[key].errors.push(error);
          });
          
          Object.values(groupedErrors).forEach(group => {
            const errorCount = group.errors.length;
              
            html += '<tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s; background: transparent;">';
            html += '<td style="padding: 8px 8px 8px 0; cursor: pointer; color: var(--text-primary);" class="node-name-cell" data-node-id="' + group.nodeId + '">' + group.nodeName + '</td>';
            html += '<td style="padding: 8px; cursor: pointer; color: var(--text-primary);" class="node-name-cell" data-node-id="' + group.nodeId + '">' + errorCount + '</td>';
            html += '<td style="padding: 8px 0 8px 8px; text-align: center;">';
            html += '<button class="button-primary fix-color-btn" style="padding: 4px 12px; font-size: 12px; cursor: pointer;" data-node-id="' + group.nodeId + '">';
            html += '–ò—Å–ø—Ä–∞–≤–∏—Ç—å';
            html += '</button>';
              html += '</td>';
              html += '</tr>';
          });
          
          html += '</tbody>';
          html += '</table>';
          html += '</div>';
        }
        
        if (html === '') {
          html = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 12px;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–≤–µ—Ç–æ–≤</div>';
        }
        
        colorsContent.innerHTML = html;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ —É–∑–ª–∞—Ö
        const nameCells = colorsContent.querySelectorAll('.node-name-cell');
        nameCells.forEach(cell => {
          const row = cell.closest('tr');
          
          cell.onmouseover = () => {
            if (row) row.style.background = 'var(--hover-bg)';
          };
          
          cell.onmouseout = () => {
            if (row) row.style.background = 'transparent';
          };
          
          cell.onclick = () => {
            const nodeId = cell.getAttribute('data-node-id');
            parent.postMessage({
              pluginMessage: {
                type: 'focus-node',
                nodeId: nodeId
              }
            }, '*');
          };
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const fixColorBtns = colorsContent.querySelectorAll('.fix-color-btn');
        fixColorBtns.forEach(btn => {
          btn.onclick = (e) => {
            e.stopPropagation();
            const nodeId = btn.getAttribute('data-node-id');
            
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –æ—à–∏–±–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞
            const errorsForNode = currentColorErrors.filter(err => err.nodeId === nodeId);
            
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —É–∑–ª–∞
            errorsForNode.forEach(error => {
              parent.postMessage({
                pluginMessage: {
                  type: 'fix-color-error',
                  error: error
                }
              }, '*');
            });
          };
        });
      }

      if (msg.type === 'color-error-fixed') {
        // –¶–≤–µ—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(() => {
          analyzeColorsBtn.click();
        }, 500);
      }

      if (msg.type === 'fix-all-colors-complete') {
        // –í—Å–µ —Ü–≤–µ—Ç–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        setTimeout(() => {
          analyzeColorsBtn.click();
        }, 500);
      }

    };
  </script>
</body>
</html>

